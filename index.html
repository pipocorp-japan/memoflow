<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ“MemoFlow</title>
    <link
      rel="icon"
      href="https://cdn.glitch.global/0beb1435-08d5-4024-b147-709f785ede69/memoflow.png?v=1740701329166"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="/manifest.json" />
    <style>
      /* åŸºæœ¬çš„ãªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆstyle.cssã«ã‚‚å®šç¾©ãŒã‚ã‚‹ã¯ãšï¼‰ */
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        z-index: 999;
      }
      .dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        z-index: 1000;
        min-width: 300px; /* ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®æœ€å°å¹… */
      }
      .overlay.show,
      .dialog.show {
        display: block; /* showã‚¯ãƒ©ã‚¹ãŒä»˜ã„ãŸã‚‰è¡¨ç¤º */
      }
      .dialog-content h2 {
        margin-top: 0;
      }
      /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆstyle.cssã«ã‚‚å®šç¾©ãŒã‚ã‚‹ã¯ãšï¼‰ */
      body.dark-mode {
        background-color: #333;
        color: #eee;
      }
      body.dark-mode .dialog {
        background-color: #444;
        color: #eee;
      }
      body.dark-mode input,
      body.dark-mode textarea,
      body.dark-mode select,
      body.dark-mode button {
        background-color: #555;
        color: #eee;
        border: 1px solid #666;
      }
      body.dark-mode button:hover {
        background-color: #666;
      }
      body.dark-mode .memo-item {
        background-color: #444;
        border: 1px solid #555;
      }
      body.dark-mode .memo-item.pinned {
        background-color: #505040; /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒ”ãƒ³ç•™ã‚è‰² */
      }
      /* ãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¾‹ (style.cssã«ã‚ã‚‹ã¹ã) */
      .memo-item {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .memo-item:hover {
        background-color: #f0f0f0;
      }
      .memo-item.pinned {
        background-color: #fffadc; /* ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒ¢ã®èƒŒæ™¯è‰² */
      }
      .memo-item button {
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ğŸ“MemoFlow</h1>
      <button id="installBtn" style="display: none">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
    </header>
    <main>
      <div class="controls">
        <input type="text" id="searchInput" placeholder="æ¤œç´¢..." />
        <button id="openMemoDialogBtn" title="æ–°ã—ã„ãƒ¡ãƒ¢ã‚’è¿½åŠ ">+</button>
        <button
          id="clearAllMemosBtn"
          class="clear-all"
          title="ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤"
        >
          ğŸ†‘
        </button>
        <button id="darkModeToggleBtn" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸ¨</button>
      </div>
      <div class="controls">
        <label for="viewFolderSelect">è¡¨ç¤ºãƒ•ã‚©ãƒ«ãƒ€:</label>
        <select id="viewFolderSelect"></select>
        <button id="deleteFolderBtn" title="é¸æŠä¸­ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤">ğŸ—‘ï¸</button>
      </div>

      <div class="overlay" id="overlay"></div>

      <div id="memoDialog" class="dialog">
        <div class="dialog-content">
          <h2 id="memoDialogTitle">ãƒ¡ãƒ¢</h2>
          <input
            type="text"
            id="memoTitleInput"
            placeholder="ã‚¿ã‚¤ãƒˆãƒ«"
            style="width: 80%; padding: 5px"
          />
          <div style="display: flex; align-items: center; margin-top: 0.5rem">
            <label for="memoFolderSelect">ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é¸æŠ:</label>
            <select id="memoFolderSelect" style="margin: 0 0.5rem"></select>
            <button id="openNewFolderDialogBtn">â•</button>
          </div>
          <hr />
          <textarea
            id="memoTextInput"
            rows="10"
            cols="50"
            placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."
          ></textarea>
          <div style="margin-top: 1rem; text-align: right">
            <button id="saveMemoBtn">ä¿å­˜</button>
            <button id="closeMemoDialogBtn">é–‰ã˜ã‚‹</button>
          </div>
        </div>
      </div>

      <div id="newFolderDialog" class="dialog">
        <div class="dialog-content">
          <h2>æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼</h2>
          <input
            type="text"
            id="newFolderNameInput"
            placeholder="æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å"
          />
          <div style="margin-top: 1rem; text-align: right">
            <button id="addFolderBtn">è¿½åŠ </button>
            <button id="cancelFolderBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>

      <h2>ãƒ¡ãƒ¢ä¸€è¦§</h2>
      <div id="memoList"></div>
    </main>
    <footer>
      <p>
        &copy; 2025 <a href="https://pipocorp.glitch.me">pipo.corp</a>. All
        Rights Reserved.
      </p>
    </footer>
    <script>
      // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
      let memos = [];
      let folders = [];
      let editingMemoIndex = -1; // ç·¨é›†ä¸­ã®ãƒ¡ãƒ¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (-1ãªã‚‰æ–°è¦)
      let isDarkMode = localStorage.getItem("darkMode") === "true";

      // --- DOMè¦ç´ ã®å–å¾— ---
      // DOMContentLoadedå¾Œã«å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
      let memoListElement,
        searchInputElement,
        viewFolderSelectElement,
        memoDialogElement,
        memoDialogTitleElement,
        memoTitleInputElement,
        memoFolderSelectElement,
        memoTextInputElement,
        newFolderDialogElement,
        newFolderNameInputElement,
        overlayElement;

      // --- localStorage é–¢é€£ ---
      function loadFolders() {
        try {
          const savedFolders = localStorage.getItem("folders");
          // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã‚„ç©ºã®å ´åˆã¯ 'default' ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
          folders = savedFolders ? JSON.parse(savedFolders) : ["default"];
          // 'default' ãƒ•ã‚©ãƒ«ãƒ€ãŒå¿…ãšå­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
          if (!folders.includes("default")) {
            folders.unshift("default");
            saveFolders();
          }
        } catch (error) {
          console.error("ãƒ•ã‚©ãƒ«ãƒ€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
          folders = ["default"]; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã®ã¿
        }
      }

      function saveFolders() {
        try {
          localStorage.setItem("folders", JSON.stringify(folders));
        } catch (error) {
          console.error("ãƒ•ã‚©ãƒ«ãƒ€ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
          alert("ãƒ•ã‚©ãƒ«ãƒ€ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      }

      function loadMemos() {
        try {
          const savedMemos = localStorage.getItem("memos");
          memos = savedMemos ? JSON.parse(savedMemos) : [];
        } catch (error) {
          console.error("ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
          memos = [];
        }
      }

      function saveMemos() {
        try {
          localStorage.setItem("memos", JSON.stringify(memos));
        } catch (error) {
          console.error("ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
          alert("ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      }

      // --- UIæ›´æ–°é–¢é€£ ---

      // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
      function renderFolderSelects() {
        const selects = [memoFolderSelectElement, viewFolderSelectElement];
        const currentViewFolderValue = viewFolderSelectElement.value; // ç¾åœ¨ã®è¡¨ç¤ºãƒ•ã‚©ãƒ«ãƒ€ã‚’ä¿æŒ

        selects.forEach((select) => {
          if (!select) return;
          const currentValue = select.value; // æ›´æ–°å‰ã®å€¤ã‚’ä¿æŒ
          select.innerHTML = ""; // ä¸€æ—¦ã‚¯ãƒªã‚¢
          folders.forEach((folderName) => {
            const option = document.createElement("option");
            option.value = folderName;
            option.textContent = folderName;
            select.appendChild(option);
          });
          // æ›´æ–°å‰ã®å€¤ãŒå­˜åœ¨ã™ã‚Œã°ã€ãã‚Œã‚’å†é¸æŠã™ã‚‹
          if (folders.includes(currentValue)) {
            select.value = currentValue;
          } else if (
            select === viewFolderSelectElement &&
            folders.includes(currentViewFolderValue)
          ) {
            // è¡¨ç¤ºãƒ•ã‚©ãƒ«ãƒ€é¸æŠè‚¢ã§ã€å‰ã®å€¤ãŒç„¡åŠ¹ã«ãªã£ãŸå ´åˆã€ä¿æŒã—ã¦ã„ãŸè¡¨ç¤ºãƒ•ã‚©ãƒ«ãƒ€ã‚’è©¦ã™
            select.value = currentViewFolderValue;
          } else if (folders.length > 0) {
            // ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰æœ€åˆã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
            select.value = folders[0];
          }
        });
        // è¡¨ç¤ºãƒ•ã‚©ãƒ«ãƒ€ãŒå¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ãƒ¡ãƒ¢ã‚’å†è¡¨ç¤º
        displayMemos();
      }

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’æ›´æ–°
      function updateDarkMode() {
        document.body.classList.toggle("dark-mode", isDarkMode);
      }

      // ãƒ¡ãƒ¢ä¸€è¦§ã‚’è¡¨ç¤º/æ›´æ–°
      function displayMemos() {
        if (!memoListElement || !viewFolderSelectElement || !searchInputElement)
          return;

        const selectedFolder = viewFolderSelectElement.value;
        const searchTerm = searchInputElement.value.toLowerCase();
        memoListElement.innerHTML = ""; // ä¸€è¦§ã‚’ã‚¯ãƒªã‚¢

        // ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒ¢ã¨ãã†ã§ãªã„ãƒ¡ãƒ¢ã‚’åˆ†ã‘ã‚‹
        const pinnedMemos = [];
        const normalMemos = [];

        memos.forEach((memo, index) => {
          // ãƒ•ã‚©ãƒ«ãƒ€ã¨æ¤œç´¢èªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          if (
            memo.folder === selectedFolder &&
            (memo.title.toLowerCase().includes(searchTerm) ||
              memo.memo.toLowerCase().includes(searchTerm))
          ) {
            // å…ƒã®é…åˆ—ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿æŒ
            const memoData = { ...memo, originalIndex: index };
            if (memo.pinned) {
              pinnedMemos.push(memoData);
            } else {
              normalMemos.push(memoData);
            }
          }
        });

        // ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒ¢ã€é€šå¸¸ã®ãƒ¡ãƒ¢ã®é †ã§è¡¨ç¤º
        const sortedMemos = [...pinnedMemos, ...normalMemos];

        sortedMemos.forEach((memoData) => {
          const memoDiv = document.createElement("div");
          memoDiv.className = "memo-item" + (memoData.pinned ? " pinned" : "");
          // ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’è¨­å®š
          memoDiv.dataset.index = memoData.originalIndex;

          // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (å¿…è¦ã§ã‚ã‚Œã°æ”¹å–„)
          const displayDate =
            memoData.updated || memoData.created || "æ—¥ä»˜ä¸æ˜";

          memoDiv.innerHTML = `
                <div>
                  <strong>${escapeHTML(memoData.title)}</strong><br>
                  <small>${escapeHTML(displayDate)}</small>
                </div>
                <div>
                  <button class="pin-button" data-index="${
                    memoData.originalIndex
                  }" title="${memoData.pinned ? "ãƒ”ãƒ³ç•™ã‚è§£é™¤" : "ãƒ”ãƒ³ç•™ã‚"}">
                    ${memoData.pinned ? "ğŸ“Œ" : "ğŸ“"}
                  </button>
                  <button class="delete-button" data-index="${
                    memoData.originalIndex
                  }" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                </div>`;
          memoListElement.appendChild(memoDiv);
        });
      }

      // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•° (ç°¡å˜ãªXSSå¯¾ç­–)
      function escapeHTML(str) {
        const div = document.createElement("div");
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
      }

      // --- ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–¢é€£ ---
      function openDialog(dialogId) {
        const dialog = document.getElementById(dialogId);
        if (!overlayElement || !dialog) {
          console.error(
            `ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¾ãŸã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${dialogId}`
          );
          return;
        }
        overlayElement.classList.add("show");
        dialog.classList.add("show");
      }

      function closeDialog(dialogId) {
        const dialog = document.getElementById(dialogId);
        if (!overlayElement || !dialog) {
          console.error(
            `ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¾ãŸã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${dialogId}`
          );
          return;
        }
        overlayElement.classList.remove("show");
        dialog.classList.remove("show");
      }

      function openMemoDialog(isNewMemo = true) {
        if (
          !memoTitleInputElement ||
          !memoTextInputElement ||
          !memoFolderSelectElement ||
          !memoDialogTitleElement
        )
          return;

        if (isNewMemo) {
          editingMemoIndex = -1; // æ–°è¦ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ‰
          memoDialogTitleElement.textContent = "æ–°ã—ã„ãƒ¡ãƒ¢";
          memoTitleInputElement.value = "";
          memoTextInputElement.value = "";
          // æ–°è¦ãƒ¡ãƒ¢æ™‚ã¯ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
          memoFolderSelectElement.value =
            viewFolderSelectElement.value || folders[0];
        } else {
          // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ (editingMemoIndex ã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹æƒ³å®š)
          if (editingMemoIndex >= 0 && editingMemoIndex < memos.length) {
            const memo = memos[editingMemoIndex];
            memoDialogTitleElement.textContent = "ãƒ¡ãƒ¢ã®ç·¨é›†";
            memoTitleInputElement.value = memo.title;
            memoTextInputElement.value = memo.memo;
            memoFolderSelectElement.value = memo.folder;
          } else {
            console.error("ç·¨é›†å¯¾è±¡ã®ãƒ¡ãƒ¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            alert("ç·¨é›†å¯¾è±¡ã®ãƒ¡ãƒ¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ãƒ¡ãƒ¢ã¨ã—ã¦é–‹ãã¾ã™ã€‚");
            openMemoDialog(true); // æ–°è¦ã¨ã—ã¦é–‹ãç›´ã™
            return;
          }
        }
        openDialog("memoDialog");
      }

      function closeMemoDialog() {
        closeDialog("memoDialog");
      }

      function openNewFolderDialog() {
        if (!newFolderNameInputElement) return;
        newFolderNameInputElement.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        openDialog("newFolderDialog");
      }

      function closeNewFolderDialog() {
        closeDialog("newFolderDialog");
      }

      // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•° ---

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
      function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        localStorage.setItem("darkMode", isDarkMode.toString()); // booleanã‚’æ–‡å­—åˆ—ã§ä¿å­˜
        updateDarkMode();
      }

      // æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¿½åŠ 
      function addFolder() {
        if (!newFolderNameInputElement) return;
        const newFolderName = newFolderNameInputElement.value.trim();

        if (!newFolderName) {
          alert("ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        if (folders.includes(newFolderName)) {
          alert("åŒã˜åå‰ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");
          return;
        }

        folders.push(newFolderName);
        saveFolders();
        renderFolderSelects(); // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
        // æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€è¿½åŠ å¾Œã€ãƒ¡ãƒ¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ãƒ•ã‚©ãƒ«ãƒ€é¸æŠè‚¢ã«è¿½åŠ ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        if (memoFolderSelectElement) {
          memoFolderSelectElement.value = newFolderName;
        }
        closeNewFolderDialog();
      }

      // é¸æŠä¸­ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
      function deleteFolder() {
        if (!viewFolderSelectElement) return;
        const folderToDelete = viewFolderSelectElement.value;

        if (!folderToDelete) {
          alert("å‰Šé™¤ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }
        if (folderToDelete === "default") {
          alert("'default' ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
          return;
        }

        const memosInFolder = memos.filter(
          (memo) => memo.folder === folderToDelete
        );
        let confirmationMessage = `ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ "${escapeHTML(
          folderToDelete
        )}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
        if (memosInFolder.length > 0) {
          confirmationMessage += `\n\nã“ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã¯ ${memosInFolder.length} ä»¶ã®ãƒ¡ãƒ¢ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ¡ãƒ¢ã‚‚ä¸€ç·’ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`;
        }

        if (confirm(confirmationMessage)) {
          // ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
          folders = folders.filter((folder) => folder !== folderToDelete);
          saveFolders();

          // ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ¡ãƒ¢ã‚‚å‰Šé™¤
          memos = memos.filter((memo) => memo.folder !== folderToDelete);
          saveMemos();

          renderFolderSelects(); // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠè‚¢ã‚’æ›´æ–°
          // displayMemos(); // renderFolderSelectså†…ã§å‘¼ã°ã‚Œã‚‹ã®ã§ä¸è¦
        }
      }

      // ãƒ¡ãƒ¢ã‚’ä¿å­˜ (æ–°è¦ã¾ãŸã¯ç·¨é›†)
      function saveMemo() {
        if (
          !memoTitleInputElement ||
          !memoTextInputElement ||
          !memoFolderSelectElement
        )
          return;

        const title = memoTitleInputElement.value.trim();
        const text = memoTextInputElement.value.trim();
        const folder = memoFolderSelectElement.value;

        if (!title || !text) {
          alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ¡ãƒ¢ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        if (!folder) {
          alert("ä¿å­˜å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const now = new Date().toLocaleString("ja-JP"); // æ—¥æœ¬èªãƒ­ã‚±ãƒ¼ãƒ«ã‚’æŒ‡å®š

        const memoData = {
          title: title,
          memo: text,
          folder: folder,
          updated: now,
          // created ã¨ pinned ã¯æ—¢å­˜ã®å€¤ã‚’ç¶­æŒã™ã‚‹ï¼ˆæ–°è¦ã®å ´åˆã¯è¨­å®šï¼‰
        };

        if (editingMemoIndex === -1) {
          // æ–°è¦ãƒ¡ãƒ¢
          memoData.created = now;
          memoData.pinned = false;
          memos.unshift(memoData); // é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
        } else {
          // ç·¨é›†ãƒ¡ãƒ¢
          if (editingMemoIndex >= 0 && editingMemoIndex < memos.length) {
            memoData.created = memos[editingMemoIndex].created; // ä½œæˆæ—¥ã¯ç¶­æŒ
            memoData.pinned = memos[editingMemoIndex].pinned; // ãƒ”ãƒ³ç•™ã‚çŠ¶æ…‹ã‚‚ç¶­æŒ
            memos[editingMemoIndex] = memoData;
          } else {
            console.error("ç·¨é›†å¯¾è±¡ã®ãƒ¡ãƒ¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™ã€‚");
            alert("ãƒ¡ãƒ¢ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            return;
          }
        }

        saveMemos();
        displayMemos(); // ãƒ¡ãƒ¢ä¸€è¦§ã‚’æ›´æ–°
        closeMemoDialog(); // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
      }

      // ãƒ¡ãƒ¢ã®ãƒ”ãƒ³ç•™ã‚/è§£é™¤ (æ›´æ–°æ—¥æ™‚ã‚’å¤‰æ›´ã—ãªã„ã‚ˆã†ã«ä¿®æ­£)
      function pinMemo(index) {
        if (index >= 0 && index < memos.length) {
          // ãƒ”ãƒ³ç•™ã‚çŠ¶æ…‹ã ã‘ã‚’åè»¢ã•ã›ã¾ã™
          memos[index].pinned = !memos[index].pinned;
          // æ›´æ–°æ—¥æ™‚ã¯å¤‰æ›´ã—ã¾ã›ã‚“ (è©²å½“è¡Œã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ)
          // memos[index].updated = new Date().toLocaleString('ja-JP');

          saveMemos(); // ãƒ”ãƒ³ç•™ã‚çŠ¶æ…‹ã®å¤‰æ›´ã‚’ä¿å­˜
          displayMemos(); // ãƒ¡ãƒ¢ä¸€è¦§ã®è¡¨ç¤ºã‚’æ›´æ–°
        } else {
          console.error("ãƒ”ãƒ³ç•™ã‚å¯¾è±¡ã®ãƒ¡ãƒ¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™:", index);
        }
      }

      // ãƒ¡ãƒ¢ã‚’å‰Šé™¤
      function deleteMemo(index) {
        if (index >= 0 && index < memos.length) {
          const memoTitle = memos[index].title;
          if (confirm(`ãƒ¡ãƒ¢ "${escapeHTML(memoTitle)}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            memos.splice(index, 1); // é…åˆ—ã‹ã‚‰å‰Šé™¤
            saveMemos();
            displayMemos(); // è¡¨ç¤ºã‚’æ›´æ–°
          }
        } else {
          console.error("å‰Šé™¤å¯¾è±¡ã®ãƒ¡ãƒ¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™:", index);
        }
      }

      // ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤
      function clearAllMemos() {
        if (
          confirm(
            "æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚"
          )
        ) {
          memos = [];
          saveMemos();
          displayMemos();
        }
      }

      // --- åˆæœŸåŒ–å‡¦ç† ---
      document.addEventListener("DOMContentLoaded", () => {
        // DOMè¦ç´ ã‚’å–å¾—
        memoListElement = document.getElementById("memoList");
        searchInputElement = document.getElementById("searchInput");
        viewFolderSelectElement = document.getElementById("viewFolderSelect");
        memoDialogElement = document.getElementById("memoDialog");
        memoDialogTitleElement = document.getElementById("memoDialogTitle");
        memoTitleInputElement = document.getElementById("memoTitleInput");
        memoFolderSelectElement = document.getElementById("memoFolderSelect");
        memoTextInputElement = document.getElementById("memoTextInput");
        newFolderDialogElement = document.getElementById("newFolderDialog");
        newFolderNameInputElement =
          document.getElementById("newFolderNameInput");
        overlayElement = document.getElementById("overlay");

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        loadFolders();
        loadMemos();

        // UIã®åˆæœŸåŒ–
        renderFolderSelects(); // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠè‚¢ã‚’ç”Ÿæˆãƒ»è¡¨ç¤º
        updateDarkMode(); // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’é©ç”¨
        displayMemos(); // åˆæœŸãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document
          .getElementById("openMemoDialogBtn")
          .addEventListener("click", () => openMemoDialog(true));
        document
          .getElementById("clearAllMemosBtn")
          .addEventListener("click", clearAllMemos);
        document
          .getElementById("darkModeToggleBtn")
          .addEventListener("click", toggleDarkMode);
        searchInputElement.addEventListener("input", displayMemos); // æ¤œç´¢å…¥åŠ›æ™‚ã«ãƒ¡ãƒ¢ã‚’å†è¡¨ç¤º
        viewFolderSelectElement.addEventListener("change", displayMemos); // è¡¨ç¤ºãƒ•ã‚©ãƒ«ãƒ€å¤‰æ›´æ™‚ã«ãƒ¡ãƒ¢ã‚’å†è¡¨ç¤º
        document
          .getElementById("deleteFolderBtn")
          .addEventListener("click", deleteFolder);

        // ãƒ¡ãƒ¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–¢é€£
        document
          .getElementById("saveMemoBtn")
          .addEventListener("click", saveMemo);
        document
          .getElementById("closeMemoDialogBtn")
          .addEventListener("click", closeMemoDialog);
        document
          .getElementById("openNewFolderDialogBtn")
          .addEventListener("click", openNewFolderDialog);

        // æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–¢é€£
        document
          .getElementById("addFolderBtn")
          .addEventListener("click", addFolder);
        document
          .getElementById("cancelFolderBtn")
          .addEventListener("click", closeNewFolderDialog);

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        overlayElement.addEventListener("click", () => {
          // é–‹ã„ã¦ã„ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’æ¢ã—ã¦é–‰ã˜ã‚‹ï¼ˆè¤‡æ•°ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒã‚ã‚‹å ´åˆã«å‚™ãˆã‚‹ï¼‰
          closeDialog("memoDialog");
          closeDialog("newFolderDialog");
          // ä»–ã«ã‚‚ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒã‚ã‚Œã°ã“ã“ã«è¿½åŠ 
        });

        // ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆå†…ã®ãƒœã‚¿ãƒ³ã«å¯¾ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        memoListElement.addEventListener("click", (event) => {
          const target = event.target;
          const memoItem = target.closest(".memo-item"); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ å†…ã‹ç¢ºèª

          if (!memoItem) return; // ãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ å¤–ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–

          const index = parseInt(memoItem.dataset.index, 10); // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‹ã‚‰å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—

          if (target.classList.contains("pin-button")) {
            // ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
            event.stopPropagation(); // ãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ è‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ãªã„
            pinMemo(index);
          } else if (target.classList.contains("delete-button")) {
            // å‰Šé™¤ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
            event.stopPropagation(); // ãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ è‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ãªã„
            deleteMemo(index);
          } else if (memoItem) {
            // ãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ è‡ªä½“ (ãƒœã‚¿ãƒ³ä»¥å¤–) ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
            editingMemoIndex = index; // ç·¨é›†å¯¾è±¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
            openMemoDialog(false); // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
          }
        });

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³: å¿…è¦ãªã‚‰å®Ÿè£…ï¼‰
        // let deferredPrompt;
        // const installButton = document.getElementById('installBtn');
        // window.addEventListener('beforeinstallprompt', (e) => {
        //   e.preventDefault();
        //   deferredPrompt = e;
        //   installButton.style.display = 'block'; // ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        //   installButton.addEventListener('click', (e) => {
        //     installButton.style.display = 'none';
        //     deferredPrompt.prompt();
        //     deferredPrompt.userChoice.then((choiceResult) => {
        //       deferredPrompt = null;
        //     });
        //   });
        // });
      });
    </script>
  </body>
</html>
